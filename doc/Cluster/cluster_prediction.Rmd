---
title: "Cluster Prediction"
author: "Daniel Parker"
date: "4/8/2018"
output: html_document
---

```{r "setup", include=FALSE}
require("knitr")
opts_knit$set(root.dir = "~/Documents/GitHub/project-3-algorithms-project-3-algorithms-group-7/doc")
```

This code is based on code from the ADS Fall 2017 Project 4 Group 8 GitHub respository, and contains modifications.

# Data Clean
## Read in data
```{r}
# Original project data
data_train <- read.csv("../data/eachmovie_sample/data_train.csv")
```
## Process
```{r}
movietrain = data_train[,-1]
nrow_movie = length(unique(movietrain[,2]))
ncol_movie = length(unique(movietrain[,1]))
movie.train.matrix = matrix(NA, nrow = nrow_movie, ncol = ncol_movie)
movie.train.matrix = reshape(movietrain, idvar = "User", timevar = "Movie", direction = "wide")
```
## Write matrix
```{r}
write.csv(movie.train.matrix,"../output/movie_train.csv", na="")
```

# Preprocessing
## Load Data
```{r}
load("../output/mv.test.matrix.Rdata")
load("../output/mv.train.matrix.Rdata")

# Original project data
data_test <- read.csv("../data/eachmovie_sample/data_test.csv")
data_train <- read.csv("../data/eachmovie_sample/data_train.csv")
```
## Write test matrix
```{r}
movie.test.matrix = reshape(data_test, idvar = "User", timevar = "Movie", direction = "wide")
write.csv(movie.test.matrix, "../output/movie_test.csv", na = "")
rownames(movie.test.matrix) <- movie.test.matrix[, 1]
movie.test.matrix <- movie.test.matrix[, -1]
movie.test.col <- colnames(movie.test.matrix)
```
## Write train matrix
```{r}
movietrain = data_train[, -1]
movie.train.matrix = reshape(movietrain, idvar = "User", timevar = "Movie", direction = "wide")
rownames(movie.train.matrix) <- movie.train.matrix[, 1]
movie.train.matrix <- movie.train.matrix[, -1]
movie.train.col <- colnames(movie.train.matrix)

common <- intersect(movie.train.col, movie.test.col)
train.col <- match(common, movie.train.col)
test.col <- match(common, movie.test.col)
new.matrix <- matrix(NA,
                     nrow = nrow(movie.train.matrix),
                     ncol = ncol(movie.train.matrix))
for (i in 1:length(common)) {
  a <- train.col[i]
  b <- test.col[i]
  new.matrix[, a] <- movie.test.matrix[, b]
  new.matrix[, i]
}
rownames(new.matrix) <- rownames(movie.train.matrix)
colnames(new.matrix) <- colnames(movie.train.matrix)
write.csv(new.matrix, "../output/movie_test_train_new.csv", na = "")
```

# EM Algorithm: included in `em.Rmd`

# Prediction
# Read in train and test data
```{r}
# ~/Downloads/movie_train.csv" is the output of `data_clean.Rmd`.
data_train <- read.csv("../output/movie_train.csv")

# "~/Downloads/movie_test_train_new.csv" is the output of `train_test_data_preprocessing.Rmd`.
test <- read.csv("../output/movie_test_train_new.csv", header = TRUE)
```

# Process to prepare for prediction function
```{r}
# Train data processing
data_train <- as.data.frame(data_train[, -1])
data_train[is.na(data_train)] <- 0
rownames(data_train) <- data_train[, 1]
data_train <- as.data.frame(data_train[, -1])
colnames(data_train) <- 1:ncol(data_train)

# Test data processing
rownames(test) <- test[, 1]
test <- test[, -1]
test[is.na(test)] <- 0
data_test <- rep(NA, nrow(test))
for (i in 1:6) {
  dat_test <- test
  dat_test[dat_test == i] <- 1
  dat_test[dat_test != i] <- 0
  data_test <- cbind(data_test, dat_test)
}
data_test <- data_test[, -1]
```

# Load estimated parameter results from previous run of EM algorithm
```{r}
load("../output/gamma_em_result_9.RData")
load("../output/mu_em_result_9.RData")
```

# Define prediction function
```{r}
prediction <- function(gamma, mu, matrixtest, matrixk, c) {
  gamma <- gamma_em_result
  mu <- mu_em_result
  matrixtest <- test
  matrixk <- data_test
  c <- 9
  k <- 6
  theta <- NULL
  N <- nrow(data_train)
  for (i in 1:c) {
    gamma_c <- gamma[((i - 1) * 6 + 1):(6 * i), ]
    gamma_c <- as.vector(t(gamma_c))
    gamma_c <- matrix(rep(gamma_c, each = N), nrow = N)
    Di <- matrixk * gamma_c
    theta_i <- apply(Di, 1, function(x) {
    return(prod(x[x > 0]))
    })
    names(theta_i) <- NULL
    theta <- rbind(theta, theta_i)
    print(i)
  }
  
  # Calculate lower
  mu_repeat <- matrix(rep(mu, each = N), nrow = N)
  prodre <- t(mu_repeat) * theta
  sum <- colSums(prodre, na.rm = TRUE)
  lower <-
    matrix(rep(sum, each = ncol(matrixtest)), 
           ncol = ncol(matrixtest),
           byrow = TRUE)
  
  # Calculate upper
  matrixsum <- matrix(rep(0, 5055 * 1619), ncol = 1619, nrow = 5055)
  pp<-NULL
  for (i in 1:k) {
    k_val_message <- paste("k value:", i)
    print(k_val_message)
    data <- as.matrix(matrixtest)
    data[data != i] <- 0
    data[data == i] <- 1 
    for (j in 1:c) {
      c_val_message <- paste("c value:", j)
      print(c_val_message)
      mu_iter <- mu[j]
      theta_iter <- theta[j, ]
      theta_iter <-
        matrix(rep(t(theta_iter), each = ncol(matrixtest)),
               ncol = ncol(matrixtest),
               byrow = TRUE)
      gamma_iter <- gamma[(6 * (j - 1) + i), ]
      gamma_me <- matrix(rep(gamma_iter, each = N), nrow = N)
      prob <- data * gamma_me
      prob <- mu_iter * prob
      prob <- prob * theta_iter
      matrixsum <- matrixsum + prob
      pp_k <- matrixsum / lower
      pp_k <- t(as.vector(t(pp_k)))
      print(j)
    } # End of c interaction
    pp <- rbind(pp, pp_k)
    print(i)
  } # End of k interaction
  mm <- apply(pp, 2, which.max)
  result <- matrix(mm, ncol = ncol(matrixtest), byrow = TRUE)
  return(result)
}
```

# Generate prediction
```{r}
start_time <- Sys.time()
r <- prediction(gamma_em_result, mu_em_result, test, data_test, 9)
end_time <- Sys.time()
prediction_time <- end_time - start_time
print(prediction_time)
```

# Save prediction
```{r}
write.csv(r, file = "../output/predict.csv")
```